<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        @font-face {
            font-family: 'Pretendard-Regular';
            src: url('https://cdn.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }
        *{font-family: 'Pretendard-Regular';}

        .sidebar_container {
            background-color: white;
            width: 236px;
            height: 467px;
            position: absolute;
            top: 230px;
            z-index: 2;
        }

        .sidebar_container_text {
            font-weight: bold;
            color: black;
            width: 140px;
            height: 50px;
            position: absolute;
            left: 28px;
            top: -5px;
            text-align: left;
            font-size: 18px;
            border-bottom: 2px solid #000;
        }
        .sidebar_button1, .sidebar_button2, .sidebar_button3{
            cursor: pointer;
            background-color: white;
            width: 236px;
            height: 43px;
            position: absolute;
            left: 0px;
        }
        .sidebar_button1 {top: 80px;}
        .sidebar_button2 {top: 120px;}
        .sidebar_button3 {top: 160px;}

        .sidebar_button1_text, .sidebar_button2_text, .sidebar_button3_text{
            position: absolute;
            text-align: center;
            color: black;
            height: 27px;
            width: 144px;
            left: 28px;
            text-align: left;
            font-size: 15px;
            letter-spacing: 0;
        }
        .sidebar_button1_text:hover, .sidebar_button2_text:hover, .sidebar_button3_text:hover{
            font-weight: bold;
        }
        .main-grid{
            display: grid;
            margin-top: 200px;
            margin-left: 250px;
            grid-template-rows: 100px 30px 30px 30px 30px 30px 30px;
            grid-template-columns: 100px 200px 100px 100px 100px 100px 100px 100px 100px;
        }
        .main-text{
            font-weight: bold;
            text-align: center;
            font-size: 22px;
            margin-top: 30px;
            grid-column: 4;
            grid-row: 1;
            border-bottom: 3px solid #000000;
        }
        .myId, .myPwd, .myGrade, .myAddress, .myEmail, .myPhone{
            text-align: center;
        }
        .myId{
            grid-column: 1/2;
            grid-row: 3;
        }
        .myIdField{
            margin-right: 10px;
            grid-column: 2;
            grid-row: 3;
        }
        .myPwd{
            grid-column: 5;
            grid-row: 3;
        }
        .myPwdField{
            margin-right: 10px;
            grid-column: 6/8;
            grid-row: 3;
        }
        .changePwd{
            grid-column: 8;
            grid-row: 3;
            margin-right: 10px;
        }
        .myPhone{
            grid-column: 1;
            grid-row: 5;
        }
        .myPhoneField{
            margin-right: 10px;
            grid-column: 2;
            grid-row: 5;
        }
        .changePhone{
            grid-column: 3;
            grid-row: 5;
        }
        .myAddress{
            text-align: center;
            grid-column: 5;
            grid-row: 5;
        }
        .myAddressDropDown{
            margin-right: 10px;
            grid-column: 6/8;
            grid-row: 5;
        }
        .addAddress{
            grid-column: 8;
            grid-row: 5;
            margin-right: 10px;
        }
        .deleteAddress{
            grid-column: 9;
            grid-row: 5;
            margin-right: 10px;
        }
        .myEmail{
            grid-column: 1;
            grid-row: 7;
        }
        .myEmailField{
            margin-right: 10px;
            grid-column: 2;
            grid-row: 7;
        }
        .changeEmail{
            grid-column: 3;
            grid-row: 7;
        }
        .myGrade{
            grid-column: 5;
            grid-row: 7;
        }
        .myGradeImg{
            text-align: center;
            grid-column: 6/8;
            grid-row: 7;
        }
        #verificationCode{
            position: relative;
            top: 310px;
            left: 100px;
        }
        #submitVerification{
            position: relative;
            top: 288px;
            left: 300px;


        }
    </style>
</head>
<body>
<header th:replace="common/header.html"></header>
<div class="sidebar_container">
    <span class="sidebar_container_text">마이 페이지</span>
    <div class="sidebar_button1">
        <span class="sidebar_button1_text">내 정보</span>
    </div>
    <div class="sidebar_button2">
        <span class="sidebar_button2_text" onclick="goOrder()">주문 목록</span>
    </div>
    <div class="sidebar_button3">
        <span class="sidebar_button3_text" onclick="goCoupon()">보유 쿠폰</span>
    </div>
</div>
<div class="main-grid">
    <tr th:each="infor : ${id}">
        <div class="main-text">내 정보</div>
        <span class="myId">내 아이디</span>
        <input type="text" readonly="true" class="myIdField" th:value="${id.getId()}">

        <span class="myPwd">내 비밀번호</span>
        <input type="password" readonly="true" id="myPwdField" class="myPwdField" value="EasterEggs">
        <button type="submit" id="changePwd" class="changePwd" onclick="changePwd()">비밀번호 변경</button>

        <span class="myPhone">내 전화번호</span>
        <input type="text" readonly="true" class="myPhoneField" id="myPhoneField"  th:value="${id.getPhone()}">
        <button type="submit" class="changePhone" id="changePhone" onclick="changePhone()">전화번호 변경</button>

        <span class="myAddress">내 주소</span>
        <select id="myAddressDropDown" class="myAddressDropDown">
            <tr th:each="addra : ${addr}">
                <option th:text="|${addra.getAddress()} ${addra.getName()}|"></option>
            </tr>
        </select>
        <button type="submit" class="addAddress" onclick="sample6_execDaumPostcode()">내 주소 추가</button>
        <button type="submit" class="deleteAddress" onclick="deleteAddr()">이 주소 삭제</button>

        <span class="myEmail">내 이메일</span>
        <input type="text" readonly="true" class="myEmailField" id="myEmailField" th:value="${id.getEmail()}">
        <button type="submit" id="changeEmail" class="changeEmail" onclick="changeEmail()">이메일 변경</button>
        <input type="hidden" id="userIdField" th:value="${id.getId()}" />

        <div id="verificationContainer" style="display:none;">
            <input type="text" id="verificationCode" name="verificationCode" placeholder="인증코드 입력"/>
            <button type="submit" id="submitVerification">인증 확인</button>
        </div>

        <span class="myGrade">내 계정 등급</span>
        <span class="myGradeImg">30x200이미지가 들어감</span>


        <button id="withdrawButton">회원 탈퇴</button>

        <script>
            document.getElementById('withdrawButton').addEventListener('click', function() {
                window.location.href = '/member/withdraw';
            });
        </script>

    </tr>
    <script>
        //주석
        function changeMyData(url, value, btn,inputField){
            if(btn.textContent === '변경하기'){
                fetch(url,{
                    method: "POST",
                    headers:{
                        'Content-Type': 'text/plain'
                    },
                    body: value
                })
                    .then(response =>{
                        return response.text();
                    })
                    .then(data => {
                        alert(data)
                    })
                    .catch((error) =>{
                        alert(error);
                    });
            } else {
                btn.textContent = '변경하기';
                inputField.readOnly = false;
                inputField.type = 'text';
            }
        }
        // function go(url, value){
        //         fetch(url,{
        //             method: "POST",
        //             headers:{
        //                 'Content-Type': 'text/plain'
        //             },
        //             body: value
        //         })
        //             .then(response =>{
        //                 return response.text();
        //             })
        //             .then(data => {
        //                 alert(data)
        //             })
        //             .catch((error) =>{
        //                 alert(error);
        //             });
        // }
        function changePhone(){
            const phoneBtn = document.getElementById('changePhone');
            const phoneInputField = document.getElementById('myPhoneField');
            changeMyData("/myPage/changePhone",phoneInputField.value,phoneBtn,phoneInputField);
        }
        // 이메일 변경 버튼을 활성화/비활성화하는 함수
        function disableChangeEmailButton(disable) {
            const changeEmailBtn = document.getElementById('changeEmail');
            changeEmailBtn.disabled = disable;
        }

        // 이메일 인증 메일을 보내는 함수
        function sendEmailVerification() {
            const emailInputField = document.getElementById('myEmailField');
            var email = emailInputField.value;
            var userId = document.getElementById('userIdField').value;

            // 이메일 변경 버튼 비활성화
            disableChangeEmailButton(true);

            fetch('/member/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `userId=${userId}&email=${email}`
            })
                .then(response => response.text())
                .then(data => {
                    console.log(data);
                    alert('이메일 인증 메일이 발송되었습니다. 이메일을 확인해주세요.');
                    document.getElementById('verificationContainer').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    // 오류 발생 시 버튼을 다시 활성화

                });     //여기까지 잘됨
        }
        // 이메일 변경 버튼을 활성화/비활성화하는 함수
        function disableChangeEmailField(disable) {
            const changeEmailField = document.getElementById('myEmailField');
            changeEmailField.disabled = disable;
        }
        // 인증 코드 확인 및 처리
        function verifyCode() {
            var emailInputField = document.getElementById('myEmailField');
            var pwd_key = document.getElementById('verificationCode').value;
            var emailBtn = document.getElementById('changeEmail')
            changeMyData("/myPage/changeEmail",emailInputField.value,emailBtn,emailInputField);

            go('/member/send-check2', pwd_key, function(responseData) {
                if (responseData === "인증 성공") {
                    // 이메일 입력 필드 활성화
                    disableChangeEmailField(false);
                    // emailInputField.disabled = false;

                    // "이메일 변경" 버튼의 텍스트와 동작 변경
                    const emailBtn = document.getElementById('changeEmail');
                    emailBtn.innerText = "이메일 수정";
                    emailBtn.disabled = false;  // 버튼 활성화
                    emailBtn.removeEventListener('click', sendEmailVerification); // 기존 이벤트 리스너 제거
                    emailBtn.addEventListener('click', changeMyEmail); // 새로운 이벤트 리스너 추가
                    alert('인증 성공');
                } else {
                    // 인증 실패 시 처리
                    alert('인증 실패. 다시 시도해주세요.');
                }
            });
        }

        function changeMyEmail() {
            const emailInputField = document.getElementById('myEmailField');
            const email = emailInputField.value;

            fetch('/myPage/changeEmail',  {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain'
                },
                body: `${email}`
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('이메일 변경 실패');
                    }
                    return response.text();
                })
                .then(data => {
                    alert('이메일이 성공적으로 변경되었습니다.');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message);
                });
        }

        // 이벤트 리스너 등록
        document.getElementById('changeEmail').addEventListener('click', sendEmailVerification);
        document.getElementById('submitVerification').addEventListener('click', verifyCode);


        function changePwd(){
            const pwdBtn = document.getElementById('changePwd');
            const pwdInputField = document.getElementById('myPwdField');
            console.log(pwdBtn.className);
            changeMyData("/myPage/changePwd",pwdInputField.value,pwdBtn,pwdInputField);
        }
        function deleteAddr(){
            const myAddressDropDown = document.getElementById('myAddressDropDown');
            const slice = myAddressDropDown.value.split(" ");
            const name = slice[slice.length -1];
            go("/myPage/deleteAddr",name,function(data){
                alert("data = "+data);
            });
        }
        function goCoupon(){
            window.location.href = "coupon"
        }

        function goOrder(){
            window.location.href = "order";
        }


    </script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="/js/common/v2.js"></script>
</div>
</body>
</html>