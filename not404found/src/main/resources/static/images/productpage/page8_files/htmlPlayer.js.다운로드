define(["ui/controls","controller"],function(){return smHtmlPlayer=function(e){var n=e;n.registerObserver(this),_userAgent=n.getUserAgent(),1==_userAgent.isMobile()&&((e=document.createElement("style")).type="text/css",e.innerHTML=".IIV::-webkit-media-controls-play-button,.IIV::-webkit-media-controls-start-playback-button {opacity: 0; pointer-events: none; width: 5px;},video::-webkit-full-screen{background-color:black;}",document.getElementsByTagName("head")[0].appendChild(e));var t,i,s,a,r=null,c=0,o=!1,u=scenappsmPlayerState.IDLE,p=!1,l=-1,d=!1,m=0,E=!1,v=!1,h=0,f=null,y=!1,L=!1,I=null,R=0,T=!1,_=-1,b=!1,g=0,k=!1;function O(){b||se(scenappsmEvent.VIDEO_BUFFERING,!0)}function P(){0!=v&&(A(),I=setTimeout(function(){b?(b=!1,A()):1==_userAgent.isMobile()&&_userAgent.getBrowserName()==_userAgent.CHROME&&"hidden"==document.visibilityState||u!=scenappsmPlayerState.PLAYING||(u=scenappsmPlayerState.ERROR,r.src="",j(),1==_isLive?(v=!1,se(scenappsmEvent.LIVE_PlAYLIST_NOT_UPDATED)):se(scenappsmEvent.ERROR,scenappsmError.NETWORK_ERROR),1==q()&&J())},1e4),se(scenappsmEvent.VIDEO_BUFFERING,!1),u!=scenappsmPlayerState.PAUSED&&(i=setTimeout(O,2e3)))}function A(){null!=I&&(clearTimeout(I),I=null),null!=i&&(clearTimeout(i),i=null)}function D(e){if(u=scenappsmPlayerState.BUFFERING,se(scenappsmEvent.VIDEO_BUFFERING),0!=parseInt(e)&&(parseInt(r.currentTime)<=parseInt(e-1)||parseInt(r.currentTime)>=parseInt(e+1))){j(),r.pause();try{e=e>r.duration&&0<r.duration&&r.duration!=1/0?r.duration-1:e,r.currentTime=e}catch(e){}clearTimeout(f),f=setTimeout(function(){D(e)},200)}else{Z(),k=!(l=-1);var t=r.play();void 0!==t&&t.then(function(){}).catch(function(e){this.muted?X():k||(ee(!0),r.play())}),1==d&&x(),clearTimeout(f)}}function N(){d&&-1!=l&&D(l)}function V(e){if(n.isVisibility()){if(null==_isLive||0==_isLive){if(0==E&&0<parseInt(h))return E=k=!0,D(h);if(0<l)return void(0==isNaN(this.duration)&&(this.currentTime=parseInt(l)));0<m&&(this.playbackRate=m)}0==d&&1==_isLive&&P(),p=!(v=!0),u!=scenappsmPlayerState.PLAYING&&(u=scenappsmPlayerState.PLAYING,se(scenappsmEvent.VIDEO_PLAY)),(g=0)==this.currentTime&&(se(scenappsmEvent.VIDEO_BUFFERING),this.style.opacity=0)}else J()}function S(e){m=this.playbackRate,g=0,A(),1==p||!_isLive&&this.currentTime==this.duration||(u=scenappsmPlayerState.PAUSED,se(scenappsmEvent.VIDEO_PAUSE))}function U(){if(m=this.playbackRate,b=!1,A(),1==_isLive)return 0==this.paused?void 0:void se(scenappsmEvent.ERROR,scenappsmError.PLAY_ERROR);v=!1,this.style.opacity=0,u=scenappsmPlayerState.COMPLETE,se(scenappsmEvent.VIDEO_COMPLETE)}function M(){0<this.buffered.length&&(loaded=this.buffered.end(this.buffered.length-1)/this.duration*100,se(scenappsmEvent.VIDEO_PROGRESS,loaded))}function w(e){1!=p&&1!=d&&(1==g?b=!1:g=1,P(),0!=this.currentTime&&""!=this.style.opacity&&(this.style.opacity=""),"none"==this.style.display&&(r.style.display=""),se(scenappsmEvent.VIDEO_TIME,{type:scenappsmConst.CURRENT_TIME,value:this.currentTime}),_isLive||0!=isNaN(this.duration)||c==this.duration||this.duration==1/0||0==this.duration||se(scenappsmEvent.VIDEO_TIME,{type:scenappsmConst.DURATION,value:this.duration}))}function F(){_isLive||0!=isNaN(this.duration)||this.duration==1/0||0==this.duration||(c=this.duration,se(scenappsmEvent.VIDEO_TIME,{type:scenappsmConst.DURATION,value:this.duration}))}function G(){0==o&&(o=!0,-1!=_&&ae(_)),_isLive||0!=isNaN(this.duration)||this.duration==1/0||0==this.duration||se(scenappsmEvent.VIDEO_TIME,{type:scenappsmConst.DURATION,value:this.duration}),0<l&&0!=this.duration&&(this.currentTime=parseInt(l))}function C(){}function Y(){if(!(0<=l))return 0<m&&this.playbackRate!=m?(this.playbackRate=m,void(m=0)):void(0!=T&&(T=!1,se(scenappsmEvent.VIDEO_RATE,this.playbackRate)))}function B(){A(),1!=p&&1!=L&&1!=d&&(L=!0,1==q()&&(u=scenappsmPlayerState.BUFFERING),se(scenappsmEvent.VIDEO_SEEK,{seeking:L,time:this.currentTime}))}function H(e){if(1!=p){if(L=!1,0<=l){if(parseInt(l)>this.currentTime+1||parseInt(l)<this.currentTime-1)return void(f=setTimeout(function(){D(l)},200));l=-1}if(1==d)return x();se(scenappsmEvent.VIDEO_SEEK,{seeking:!1,time:this.currentTime})}}function x(){d=!1,0<m&&(r.playbackRate=m),r.paused?z():(u=scenappsmPlayerState.PLAYING,se(scenappsmEvent.VIDEO_PLAY))}function K(e){A(),se(scenappsmEvent.ERROR,scenappsmError.PLAY_ERROR)}function Q(e){}function W(e){}function Z(){j(),c=0,r.addEventListener("canplay",N),r.addEventListener("play",V),r.addEventListener("pause",S),r.addEventListener("loadedmetadata",G),r.addEventListener("progress",M),r.addEventListener("timeupdate",w),r.addEventListener("durationchange",F),r.addEventListener("volumechange",C),r.addEventListener("ratechange",Y),r.addEventListener("seeking",B),r.addEventListener("seeked",H),r.addEventListener("ended",U),r.addEventListener("error",K),r.addEventListener("emptied",W),r.addEventListener("waiting",Q)}function j(){r.removeEventListener("canplay",N),r.removeEventListener("play",V),r.removeEventListener("pause",S),r.removeEventListener("loadedmetadata",G),r.removeEventListener("progress",M),r.removeEventListener("timeupdate",w),r.removeEventListener("durationchange",F),r.removeEventListener("volumechange",C),r.removeEventListener("ratechange",Y),r.removeEventListener("seeking",B),r.removeEventListener("seeked",H),r.removeEventListener("ended",U),r.removeEventListener("error",K),r.removeEventListener("emptied",W),r.removeEventListener("waiting",Q)}function q(){return 0!=v&&!r.paused}function z(){try{(0==a&&0==v||_isLive&&0==c)&&te(s,!0),0==v&&1==_userAgent.isMobile()&&(r.src=r.src),p&&Z();var e=r.play();void 0!==e&&e.then(function(){}).catch(function(e){this.muted?X():k||(ee(!0),r.play())})}catch(e){}}function J(){A(),r.pause()}function X(){A(),j(),$(0),r.pause(),v=!(p=!0),u=scenappsmPlayerState.IDLE,se(scenappsmEvent.VIDEO_STOP)}function $(e){r.currentTime=e}function ee(e){r.muted=e,se(scenappsmEvent.VIDEO_VOLUME,{volume:r.volume,muted:r.muted})}function te(e,t){Z(),s=e,1!=a&&1!=t||(r.src=ie(s.src))}function ne(){r.style.display="none"}function ie(e){return 0<R&&(e+="&dRate="+R),e.replace("&type=pseudo","").replace("&ch=true","")}function se(e,t){1!=y&&n.notifyObserver(e,t)}function ae(e){for(var t=r.textTracks,n=0;n<t.length;n++)t[n].mode=e-1==n?"showing":"disabled"}function re(){window.open(t)}(r=scenappsm._elements.createElement("video","IIV","my_video")).style.width="100%",r.style.height="100%",r.style.setProperty("background","black","important"),r.preload="metadata",r.setAttribute("webkit-playsinline","true"),r.setAttribute("playsinline",""),r.setAttribute("x-webkit-airplay",""),r.setAttribute("controlsList","nodownload"),r.addEventListener("contextmenu",function(e){e.preventDefault()}),ne(),this.setPreload=function(e){a=e};var ce=!(this.setViralLink=function(e){scenappsm.removeEventListener(r,"click",re),null!=e&&""!=e&&(t=e,scenappsm.addEventListener(r,"click",re))});this.oneSkipPlayCheck=function(){1==_userAgent.isMobile()&&(r.removeEventListener("timeupdate",w),ce=b=!0)},this.update=function(e,t){switch(e){case scenappsmEvent.VIDEO_READY:_isLive="live"==t.pack;break;case scenappsmEvent.CAPTION:if(0==_userAgent.isMobile())return;var n,i;for(n in t)"VTT"!=t[n].format&&"SRT"!=t[n].format||(i=1==t[n].default?"default":"",r.innerHTML+='<track kind="captions" src="'+t[n].url+'" srclang="'+t[n].code+'" label="'+t[n].label+'" '+i+"/>");break;case scenappsmEvent.CAPTION_CHANGE:if(0==_userAgent.isMobile())return;ae(_=t);break;case scenappsmEvent.VIDEO_PLAY:ce&&(r.addEventListener("timeupdate",w),ce=!1);break;case scenappsmEvent.RESIZE:_userAgent.isIOS()&&(r.style.width="99.9%",setTimeout(function(){r.style.width="100%"},100))}},this.isLock=function(e){y=e},this.setQuality=function(e){A(),0==_isLive&&(d=!0,l=r.currentTime,ne()),m=r.playbackRate,s=e.source,r.src=ie(e.source.src),z(),u=scenappsmPlayerState.BUFFERING,se(scenappsmEvent.QUALITY_CHANGE,e)},this.switchLoad=function(e){d=!0,l=r.currentTime,m=r.playbackRate,r.src=ie(e.source.src),z(),u=scenappsmPlayerState.BUFFERING,se(scenappsmEvent.QUALITY_CHANGE,e)},this.load=te,this.startTime=function(e){h=e},this.setID=function(e){r.id=e},this.setDRate=function(e){R=e},this.getState=function(){return u},this.setState=function(e){u=e},this.getDuration=function(){return r.duration},this.setPlaybackRate=function(e){T=!0,m=0,r.playbackRate=e},this.getPlaybackRate=function(){return r.playbackRate},this.getMuted=function(){return r.muted},this.setMuted=ee,this.getVolume=function(){return parseInt(100*r.volume)},this.setVolume=function(e){1!=isNaN(e/100)&&r.volume!=e/100&&(r.volume=e/100,se(scenappsmEvent.VIDEO_VOLUME,{volume:r.volume,muted:r.muted}))},this.getPosition=function(){return r.currentTime},this.setPosition=$,this.stop=X,this.pause=J,this.play=z,this.init=function(){r.style.display="block",m=r.playbackRate,r.load()},this.playing=q,this.getPlayer=function(){return r},this.getVideo=function(){return r},this.addEventListener=Z,this.removeEventListener=j,Z()},smHtmlPlayer});